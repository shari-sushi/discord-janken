# Redis CRUD Web API 実装計画

**作成日**: 2026-01-31
**バージョン**: v1

## 1. 概要

Redisの動作確認ができるCRUD操作のWeb APIを実装します。

### 目的
- Redisのデータ操作をHTTP経由で実行可能にする
- 開発・検証環境でのRedis動作確認を容易にする
- クライアント側からRedisの基本操作をテストできるようにする

### 技術スタック
- Next.js App Router
- Redis (既存パッケージ利用)
- TypeScript

## 2. セキュリティ対策

### 2.1 認証
既存の `WEB_API_SECRET` 認証機構を使用
- `Authorization: Bearer <WEB_API_SECRET>` ヘッダーによる認証
- 未認証リクエストは 404 NotFound で拒否してリソースの存在を隠匿

### 2.2 入力バリデーション
**キー (key)**
- 必須項目
- 文字列型
- 最大長: 256文字
- 許可文字: 英数字、ハイフン、アンダースコア、コロン (`[a-zA-Z0-9_:-]+`)
- コロン `:` の使用について：
  - 階層構造の区切り文字として `:` を許可
  - **注意**: `:` を許容するため、ユーザー入力を含むキーを構成する場合は階層構造が崩れる可能性がある
  - 推奨パターン: `{リソース種別}:{ID}:{属性}:{サブ属性}` (例: `match:123:blueTeam:member`)

**値 (value)**
- 必須項目（create/updateのみ）
- 文字列型
- 最大長: 10MB (10,485,760 bytes)
- JSON文字列も文字列として保存可能

### 2.3 Redisコマンドインジェクション対策
- ユーザー入力を直接Redisコマンドに渡さない
- Redis公式クライアントのパラメータ化されたメソッドのみ使用
- 特殊文字のエスケープは不要（クライアントライブラリが処理）

### 2.4 キー設計のベストプラクティス
- **階層構造**: コロン `:` で階層を表現（例: `match:123:blueTeam:member`）
- **パターン例**:
  ```
  match:{matchId}:blueTeam:member
  match:{matchId}:redTeam:member
  user:{userId}:profile
  user:{userId}:settings
  ```
- **前方一致検索**: `KEYS match:123:*` で特定matchの全データ取得可能
- **注意事項**:
  - ユーザー入力をキーに含める場合、`:` を除去/置換する
  - 例: `const safeUserName = userName.replace(/:/g, '-')`

### 2.5 その他の対策
- エラーメッセージで内部情報を露出しない
- レート制限は将来的に実装を検討

## 3. ディレクトリ構造

```
my-app/
└── app/
    └── api/
        └── web/
            ├── _handlers/
            │   └── redisOperations.ts  # Redis操作の共通ロジック
            └── crud/
                ├── create/
                │   └── route.ts
                ├── get/
                │   └── route.ts
                ├── update/
                │   └── route.ts
                └── delete/
                    └── route.ts
```

## 4. API定義

### 共通仕様

**ベースURL**: `/api/web/crud`

**認証**:
```
Authorization: Bearer <WEB_API_SECRET>
```

**共通レスポンスフォーマット**:
```typescript
// 成功
{
  "success": true,
  "data": any
}

// エラー
{
  "success": false,
  "error": string
}
```

### 4.1 CREATE - データ作成

**エンドポイント**: `POST /api/web/crud/create`

**リクエストボディ**:
```json
{
  "key": "match:123:blueTeam:member",
  "value": "John Doe"
}
```

**レスポンス**:
```json
{
  "success": true,
  "data": {
    "key": "match:123:blueTeam:member",
    "created": true
  }
}
```

**エラーケース**:

- 400: keyまたはvalueが不正
- 404: 認証失敗
- 409: キーが既に存在する
- 500: Redis接続エラー

### 4.2 GET - データ取得

**エンドポイント**: `POST /api/web/crud/get`

**リクエストボディ**:

```json
{
  "key": "match:123:blueTeam:member"
}
```

**レスポンス**:
```json
{
  "success": true,
  "data": {
    "key": "match:123:blueTeam:member",
    "value": "John Doe",
    "exists": true
  }
}
```

**キーが存在しない場合**:
```json
{
  "success": true,
  "data": {
    "key": "match:123:blueTeam:member",
    "value": null,
    "exists": false
  }
}
```

**エラーケース**:
- 400: keyが不正
- 404: 認証失敗
- 500: Redis接続エラー

### 4.3 UPDATE - データ更新

**エンドポイント**: `POST /api/web/crud/update`

**リクエストボディ**:
```json
{
  "key": "match:123:blueTeam:member",
  "value": "Jane Doe"
}
```

**レスポンス**:
```json
{
  "success": true,
  "data": {
    "key": "match:123:blueTeam:member",
    "updated": true
  }
}
```

**エラーケース**:
- 400: keyまたはvalueが不正
- 404: 認証失敗 リソースの存在を隠匿するため
- 404: キーが存在しない
- 500: Redis接続エラー

### 4.4 DELETE - データ削除

**エンドポイント**: `POST /api/web/crud/delete`

**リクエストボディ**:
```json
{
  "key": "match:123:blueTeam:member"
}
```

**レスポンス**:
```json
{
  "success": true,
  "data": {
    "key": "match:123:blueTeam:member",
    "deleted": true
  }
}
```

**キーが存在しない場合**:
```json
{
  "success": true,
  "data": {
    "key": "match:123:blueTeam:member",
    "deleted": false
  }
}
```

**エラーケース**:
- 400: keyが不正
- 404: 認証失敗 リソースの存在を隠匿するため
- 500: Redis接続エラー

## 5. 実装手順

### ステップ1: 共通ハンドラーの作成
- `my-app/app/api/web/_handlers/redisOperations.ts` を作成
- **既存のRedis実装を活用**: `app/libs/redis/redis.ts` の関数を使用
  - `redisGet`, `redisSet`, `redisUpdate`, `redisDelete`, `redisExists` を利用
  - 動作を保証するため、共通のRedisクライアントを使用
- バリデーション関数
  - **重要**: バリデーション関数に以下のNOTEコメントを追加
    ```typescript
    // NOTE: コロン `:` を許容しているため、ユーザー入力をキーに含める場合は
    // 階層構造が意図せず崩れる可能性があります。
    // クライアント側でユーザー入力に `:` が含まれないよう処理することを推奨します。
    // 例: userName.replace(/:/g, '-')
    ```
- CRUD操作の実装

### ステップ2: ディレクトリ構造の作成
```bash
mkdir -p my-app/app/api/web/crud/{create,get,update,delete}
```

### ステップ3: 各エンドポイントの route.ts を作成
- `create/route.ts`: POSTメソッド、認証チェック、バリデーション、createハンドラー呼び出し
- `get/route.ts`: POSTメソッド、認証チェック、バリデーション、getハンドラー呼び出し
- `update/route.ts`: POSTメソッド、認証チェック、バリデーション、updateハンドラー呼び出し
- `delete/route.ts`: POSTメソッド、認証チェック、バリデーション、deleteハンドラー呼び出し

### ステップ4: 環境変数の確認
`.env.local` に以下が設定されていることを確認：
```
WEB_API_SECRET=your-secret-key
REDIS_URL=redis://...
```

### ステップ5: テスト

## 6. テスト方法

### curlでのテスト例

**CREATE**:
```bash
curl -X POST http://localhost:3000/api/web/crud/create \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_SECRET" \
  -d '{"key":"match:123:blueTeam:member","value":"Hello Redis"}'
```

**GET**:
```bash
curl -X POST http://localhost:3000/api/web/crud/get \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_SECRET" \
  -d '{"key":"match:123:blueTeam:member"}'
```

**UPDATE**:
```bash
curl -X POST http://localhost:3000/api/web/crud/update \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_SECRET" \
  -d '{"key":"match:123:blueTeam:member","value":"Updated Value"}'
```

**DELETE**:
```bash
curl -X POST http://localhost:3000/api/web/crud/delete \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_SECRET" \
  -d '{"key":"match:123:blueTeam:member"}'
```

### テストシナリオ

1. **正常系**
   - CREATE → GET → UPDATE → GET → DELETE → GET の順で実行
   - 各ステップで期待値を確認

2. **バリデーションエラー**
   - 長すぎるキーや値（256文字超過、10MB超過）
   - 不正な文字を含むキー（許可されていない特殊文字など）
   - 空文字列のキー

3. **認証エラー**
   - Authorizationヘッダーなし
   - 不正なトークン

4. **存在チェック**
   - CREATE時に既存キーを指定
   - UPDATE時に存在しないキーを指定
   - DELETE時に存在しないキーを指定

## 7. クライアント実装への引き継ぎ情報

### TypeScript型定義

```typescript
// リクエスト型
interface CreateRequest {
  key: string;  // 例: "match:123:blueTeam:member"
  value: string;
}

interface GetRequest {
  key: string;
}

interface UpdateRequest {
  key: string;
  value: string;
}

interface DeleteRequest {
  key: string;
}

// レスポンス型
interface ApiResponse<T> {
  success: boolean;
  data?: T;
  error?: string;
}

interface CreateResponse {
  key: string;
  created: boolean;
}

interface GetResponse {
  key: string;
  value: string | null;
  exists: boolean;
}

interface UpdateResponse {
  key: string;
  updated: boolean;
}

interface DeleteResponse {
  key: string;
  deleted: boolean;
}
```

### 使用例（fetch）

```typescript
const API_BASE = '/api/web/crud';
const API_SECRET = process.env.NEXT_PUBLIC_WEB_API_SECRET;

async function createData(key: string, value: string) {
  const response = await fetch(`${API_BASE}/create`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${API_SECRET}`,
    },
    body: JSON.stringify({ key, value }),
  });
  return await response.json();
}

async function getData(key: string) {
  const response = await fetch(`${API_BASE}/get`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${API_SECRET}`,
    },
    body: JSON.stringify({ key }),
  });
  return await response.json();
}

async function updateData(key: string, value: string) {
  const response = await fetch(`${API_BASE}/update`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${API_SECRET}`,
    },
    body: JSON.stringify({ key, value }),
  });
  return await response.json();
}

async function deleteData(key: string) {
  const response = await fetch(`${API_BASE}/delete`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${API_SECRET}`,
    },
    body: JSON.stringify({ key }),
  });
  return await response.json();
}
```

## 8. 今後の拡張案

- レート制限の実装（Redis自体を使ったレート制限）
- キーの一覧取得API（パターンマッチング）
- TTL（有効期限）の設定機能
- バッチ操作（複数キーの一括処理）
- WebSocketによるリアルタイム通知
- 管理画面UI（Next.jsページとして実装）

## 9. 注意事項

- このAPIは開発・検証目的です
- 本番環境では適切なアクセス制御を追加してください
- **キー設計の重要な注意点**:
  - コロン `:` を階層区切り文字として許可しています
  - ユーザー入力をキーに含める場合、`:` が含まれると階層構造が意図せず崩れます
  - クライアント側で必ずユーザー入力から `:` を除去または置換してください
  - 推奨: `userName.replace(/:/g, '-')` のような処理を実装
- キーの命名規則を統一することを推奨（例: `{リソース}:{ID}:{属性}`）
